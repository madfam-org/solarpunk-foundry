#!/bin/bash
# Platform Control Script
# Manages Janua + Enclii + Avala local development stack
#
# Usage:
#   ./platform up        Start all services
#   ./platform down      Stop all services
#   ./platform logs      Follow logs
#   ./platform status    Check service health
#   ./platform reset     Reset all data (destructive)
#   ./platform migrate   Run database migrations

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
COMPOSE_FILE="$SCRIPT_DIR/docker-compose.platform.yml"
PROJECT_NAME="madfam-platform"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
    echo -e "${BLUE}"
    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║           MADFAM Platform Stack Controller                   ║"
    echo "║   Janua (Auth) + Enclii (PaaS) + Avala (LMS)                ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

print_ports() {
    echo -e "${GREEN}Service Endpoints:${NC}"
    echo "┌─────────────────────────────────────────────────────────────────┐"
    echo "│ Infrastructure:                                                 │"
    echo "│   PostgreSQL      : localhost:5432                              │"
    echo "│   Redis           : localhost:6379                              │"
    echo "│   MinIO Console   : http://localhost:9001                       │"
    echo "│   MailHog         : http://localhost:8025                       │"
    echo "│   Traefik Dashboard: http://localhost:8080                      │"
    echo "├─────────────────────────────────────────────────────────────────┤"
    echo "│ Janua (Authentication):                                         │"
    echo "│   API             : http://localhost:8000                       │"
    echo "│   Web             : http://localhost:3001                       │"
    echo "├─────────────────────────────────────────────────────────────────┤"
    echo "│ Enclii (PaaS):                                                  │"
    echo "│   API             : http://localhost:8001                       │"
    echo "│   UI              : http://localhost:8030                       │"
    echo "├─────────────────────────────────────────────────────────────────┤"
    echo "│ Avala (LMS):                                                    │"
    echo "│   API             : http://localhost:4000                       │"
    echo "│   Web             : http://localhost:3010                       │"
    echo "└─────────────────────────────────────────────────────────────────┘"
}

cmd_up() {
    print_header
    echo -e "${YELLOW}Starting platform services...${NC}"

    # Start infrastructure first
    docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" up -d postgres redis mailhog minio traefik registry

    echo -e "${YELLOW}Waiting for infrastructure to be healthy...${NC}"
    sleep 5

    # Check postgres health
    until docker exec platform-postgres pg_isready -U platform -d platform_dev > /dev/null 2>&1; do
        echo "Waiting for PostgreSQL..."
        sleep 2
    done
    echo -e "${GREEN}PostgreSQL is ready${NC}"

    # Check redis health
    until docker exec platform-redis redis-cli ping > /dev/null 2>&1; do
        echo "Waiting for Redis..."
        sleep 2
    done
    echo -e "${GREEN}Redis is ready${NC}"

    # Start Janua first (auth dependency)
    echo -e "${YELLOW}Starting Janua (Authentication)...${NC}"
    docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" up -d janua-api janua-web
    sleep 3

    # Start Enclii and Avala
    echo -e "${YELLOW}Starting Enclii (PaaS) and Avala (LMS)...${NC}"
    docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" up -d enclii-api enclii-ui avala-api avala-web

    echo ""
    echo -e "${GREEN}✓ Platform stack started successfully!${NC}"
    echo ""
    print_ports
}

cmd_down() {
    print_header
    echo -e "${YELLOW}Stopping platform services...${NC}"
    docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" down
    echo -e "${GREEN}✓ Platform stack stopped${NC}"
}

cmd_logs() {
    local service="${1:-}"
    if [ -n "$service" ]; then
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" logs -f "$service"
    else
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" logs -f
    fi
}

cmd_status() {
    print_header
    echo -e "${BLUE}Container Status:${NC}"
    docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" ps

    echo ""
    echo -e "${BLUE}Health Checks:${NC}"

    # Check each service
    check_service() {
        local name=$1
        local url=$2
        if curl -s -o /dev/null -w "%{http_code}" "$url" | grep -q "200\|301\|302"; then
            echo -e "  ${GREEN}✓${NC} $name"
        else
            echo -e "  ${RED}✗${NC} $name"
        fi
    }

    check_service "Janua API" "http://localhost:8000/health" 2>/dev/null || echo -e "  ${RED}✗${NC} Janua API"
    check_service "Enclii API" "http://localhost:8001/health" 2>/dev/null || echo -e "  ${RED}✗${NC} Enclii API"
    check_service "Avala API" "http://localhost:4000/health" 2>/dev/null || echo -e "  ${RED}✗${NC} Avala API"
    check_service "Traefik" "http://localhost:8080/api/overview" 2>/dev/null || echo -e "  ${RED}✗${NC} Traefik"
}

cmd_reset() {
    print_header
    echo -e "${RED}WARNING: This will delete all data!${NC}"
    read -p "Are you sure? (yes/no): " confirm
    if [ "$confirm" = "yes" ]; then
        echo -e "${YELLOW}Stopping and removing all containers and volumes...${NC}"
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" down -v
        echo -e "${GREEN}✓ Platform reset complete${NC}"
    else
        echo "Aborted."
    fi
}

cmd_migrate() {
    print_header
    echo -e "${YELLOW}Running database migrations...${NC}"

    # Janua migrations
    echo -e "${BLUE}Janua migrations...${NC}"
    docker exec janua-api pnpm db:migrate 2>/dev/null || echo "Janua migration skipped (service not running or no migrations)"

    # Avala migrations
    echo -e "${BLUE}Avala migrations...${NC}"
    docker exec avala-api pnpm db:migrate 2>/dev/null || echo "Avala migration skipped (service not running or no migrations)"

    echo -e "${GREEN}✓ Migrations complete${NC}"
}

cmd_seed() {
    print_header
    echo -e "${YELLOW}Seeding databases...${NC}"

    # Janua seed
    echo -e "${BLUE}Seeding Janua...${NC}"
    docker exec janua-api pnpm db:seed 2>/dev/null || echo "Janua seed skipped"

    # Avala seed
    echo -e "${BLUE}Seeding Avala...${NC}"
    docker exec avala-api pnpm db:seed 2>/dev/null || echo "Avala seed skipped"

    echo -e "${GREEN}✓ Seeding complete${NC}"
}

cmd_help() {
    print_header
    echo "Usage: $0 <command> [options]"
    echo ""
    echo "Commands:"
    echo "  up        Start all platform services"
    echo "  down      Stop all platform services"
    echo "  logs      Follow logs (optionally specify service name)"
    echo "  status    Check health of all services"
    echo "  reset     Stop and remove all data (destructive)"
    echo "  migrate   Run database migrations"
    echo "  seed      Seed databases with test data"
    echo "  help      Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 up                    # Start everything"
    echo "  $0 logs janua-api        # Follow Janua API logs"
    echo "  $0 status                # Check all services"
}

# Main
case "${1:-help}" in
    up)
        cmd_up
        ;;
    down)
        cmd_down
        ;;
    logs)
        cmd_logs "$2"
        ;;
    status)
        cmd_status
        ;;
    reset)
        cmd_reset
        ;;
    migrate)
        cmd_migrate
        ;;
    seed)
        cmd_seed
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        cmd_help
        exit 1
        ;;
esac
