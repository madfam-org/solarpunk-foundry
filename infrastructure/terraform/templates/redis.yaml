#cloud-config
# Janua Redis Server Initialization
# =================================

hostname: janua-redis

package_update: true
package_upgrade: true

packages:
  - redis-server
  - curl
  - htop
  - fail2ban
  - ufw

write_files:
  # Redis configuration
  - path: /etc/redis/redis.conf
    content: |
      # Janua Redis Configuration
      # =========================

      # Network
      bind 10.1.2.20 127.0.0.1
      port 6379
      protected-mode yes

      # Authentication
      requirepass ${redis_password}

      # General
      daemonize yes
      supervised systemd
      pidfile /run/redis/redis-server.pid
      loglevel notice
      logfile /var/log/redis/redis-server.log

      # Snapshotting (RDB)
      save 900 1
      save 300 10
      save 60 10000
      stop-writes-on-bgsave-error yes
      rdbcompression yes
      rdbchecksum yes
      dbfilename dump.rdb
      dir /var/lib/redis

      # Append Only File (AOF)
      appendonly yes
      appendfilename "appendonly.aof"
      appendfsync everysec
      no-appendfsync-on-rewrite no
      auto-aof-rewrite-percentage 100
      auto-aof-rewrite-min-size 64mb
      aof-load-truncated yes
      aof-use-rdb-preamble yes

      # Memory Management (optimized for 2GB server)
      maxmemory 1gb
      maxmemory-policy allkeys-lru
      maxmemory-samples 5

      # Lazy Freeing
      lazyfree-lazy-eviction no
      lazyfree-lazy-expire no
      lazyfree-lazy-server-del no
      replica-lazy-flush no

      # Client Output Buffer Limits
      client-output-buffer-limit normal 0 0 0
      client-output-buffer-limit replica 256mb 64mb 60
      client-output-buffer-limit pubsub 32mb 8mb 60

      # Timeout
      timeout 300
      tcp-keepalive 300

      # Slow Log
      slowlog-log-slower-than 10000
      slowlog-max-len 128

      # Active Defragmentation
      activedefrag no

      # Security
      rename-command FLUSHDB ""
      rename-command FLUSHALL ""
      rename-command DEBUG ""

  # Health check script
  - path: /opt/scripts/health-check.sh
    permissions: '0755'
    content: |
      #!/bin/bash

      echo "=== Redis Health Check ==="

      # Check if Redis is running
      if systemctl is-active --quiet redis-server; then
        echo "âœ… Redis service: running"
      else
        echo "âŒ Redis service: not running"
        exit 1
      fi

      # Check if Redis responds to ping
      if redis-cli -a '${redis_password}' ping 2>/dev/null | grep -q PONG; then
        echo "âœ… Redis ping: PONG"
      else
        echo "âŒ Redis ping: failed"
        exit 1
      fi

      # Get info
      echo ""
      echo "ðŸ“Š Redis Info:"
      redis-cli -a '${redis_password}' info server 2>/dev/null | grep -E "redis_version|uptime_in_days|connected_clients"
      redis-cli -a '${redis_password}' info memory 2>/dev/null | grep -E "used_memory_human|maxmemory_human"
      redis-cli -a '${redis_password}' info stats 2>/dev/null | grep -E "total_connections_received|total_commands_processed"

  # Backup script
  - path: /opt/scripts/backup-redis.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      BACKUP_DIR="/var/backups/redis"
      DATE=$(date +%Y%m%d_%H%M%S)

      mkdir -p $BACKUP_DIR

      # Trigger BGSAVE
      redis-cli -a '${redis_password}' BGSAVE

      # Wait for save to complete
      while [ $(redis-cli -a '${redis_password}' LASTSAVE) == $(redis-cli -a '${redis_password}' LASTSAVE) ]; do
        sleep 1
      done

      # Copy dump file
      cp /var/lib/redis/dump.rdb "$BACKUP_DIR/dump_$DATE.rdb"

      # Keep only last 7 days
      find $BACKUP_DIR -name "dump_*.rdb" -mtime +7 -delete

      echo "Backup completed: $BACKUP_DIR/dump_$DATE.rdb"

  # UFW firewall rules
  - path: /opt/scripts/setup-firewall.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      ufw --force reset
      ufw default deny incoming
      ufw default allow outgoing

      # Allow SSH from private network only
      ufw allow from 10.1.0.0/16 to any port 22

      # Allow Redis from app subnet only
      ufw allow from 10.1.1.0/24 to any port 6379

      ufw --force enable
      echo "Firewall configured"

  # Cron job for daily backups
  - path: /etc/cron.d/redis-backup
    content: |
      # Daily backup at 4 AM (after PostgreSQL backup)
      0 4 * * * root /opt/scripts/backup-redis.sh >> /var/log/redis-backup.log 2>&1

  # Systemd override for Redis
  - path: /etc/systemd/system/redis-server.service.d/override.conf
    content: |
      [Service]
      # Increase open file limits
      LimitNOFILE=65535

runcmd:
  # Set kernel parameters for Redis
  - sysctl vm.overcommit_memory=1
  - echo "vm.overcommit_memory = 1" >> /etc/sysctl.conf
  - sysctl net.core.somaxconn=65535
  - echo "net.core.somaxconn = 65535" >> /etc/sysctl.conf

  # Disable transparent huge pages
  - echo never > /sys/kernel/mm/transparent_hugepage/enabled
  - |
    cat >> /etc/rc.local <<EOF
    echo never > /sys/kernel/mm/transparent_hugepage/enabled
    EOF
  - chmod +x /etc/rc.local

  # Reload systemd and restart Redis
  - systemctl daemon-reload
  - systemctl restart redis-server
  - systemctl enable redis-server

  # Setup firewall
  - /opt/scripts/setup-firewall.sh

  # Enable fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  - echo "Redis server initialization complete" | tee /var/log/cloud-init-redis.log

final_message: "Redis server ready after $UPTIME seconds"
