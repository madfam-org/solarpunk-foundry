# Production Deployment Patch
# ===========================
# Adds all secrets and RS256 JWT key support for production
apiVersion: apps/v1
kind: Deployment
metadata:
  name: janua-api
  namespace: janua
spec:
  template:
    spec:
      containers:
        - name: janua-api
          env:
            # Core secrets (from janua-secrets)
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: secret-key
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: database-url
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: redis-url
            - name: JWT_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: jwt-secret
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: jwt-secret

            # RS256 JWT Keys (from janua-jwt-keys)
            - name: JWT_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: janua-jwt-keys
                  key: JWT_PRIVATE_KEY
            - name: JWT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: janua-jwt-keys
                  key: JWT_PUBLIC_KEY

            # Key file paths (alternative to env vars)
            - name: JWT_PRIVATE_KEY_PATH
              value: /etc/janua/keys/private.pem
            - name: JWT_PUBLIC_KEY_PATH
              value: /etc/janua/keys/public.pem

            # OIDC Issuer (must match OIDC discovery)
            - name: JWT_ISSUER
              value: "https://auth.madfam.io"
            - name: BASE_URL
              value: "https://auth.madfam.io"

          # Mount JWT keys as files (backup to env vars)
          volumeMounts:
            - name: jwt-keys
              mountPath: /etc/janua/keys
              readOnly: true

      # JWT Keys Volume
      volumes:
        - name: jwt-keys
          secret:
            secretName: janua-jwt-keys
            defaultMode: 0400
            items:
              - key: JWT_PRIVATE_KEY
                path: private.pem
              - key: JWT_PUBLIC_KEY
                path: public.pem
